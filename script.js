/* eslint-disable */

// --- قاموس الترجمة الكامل (معدل) ---
const translations = {
  ar: {
    siteTitle: "عيادة [family clinic]",
    logoText: "Family Clinic", 
    navHome: "الرئيسية",
    navAbout: "من نحن", 
    navServices: "الخدمات",
    navDoctors: "الأطباء",
    navBooking: "حجز موعد",
    navContact: "اتصل بنا",
    navDrMaged: "د/ ماجد فوزي",
    navDrShahira: "د/ شهيرة لويز",
    langBtn: "English", 
    heroTitle: "نحن نهتم بصحتك",
    heroSubtitle: "أفضل رعاية طبية على يد أمهر الأطباء.",
    heroBtn: "احجز موعد الآن",
    aboutTitle: "من نحن",
    aboutText: "عيادة [family clinic] هي مركز طبي متكامل يجمع بين الخبرة العميقة والاهتمام الفردي لتقديم أفضل رعاية صحية لجميع أفراد الأسرة. نحن نؤمن بأن الصحة هي أساس الحياة السعيدة، ولهذا نلتزم بتوفير خدمات تشخيصية وعلاجية دقيقة في بيئة مريحة وآمنة.",
    missionTitle: "رسالتنا",
    missionText: "تقديم خدمات رعاية صحية عالية الجودة تتسم بالدقة والاحترافية، مع التركيز على بناء علاقة ثقة مستدامة مع مرضانا من خلال التعليم الصحي والدعم المستمر.",
    visionTitle: "رؤيتنا",
    visionText: "أن نكون العيادة الرائدة والموثوقة في تقديم رعاية صحية شاملة ومبتكرة، وأن نصبح الخيار الأول للأسرة الباحثة عن التميز الطبي.",
    servicesTitle: "خدماتنا",
    servicesMagedTitle: "خدمات الباطنة والكلى (د/ ماجد فوزي)",
    serviceMaged1Title: "متابعة السكري والضغط",
    serviceMaged1Desc: "متابعة دورية لحالات السكري وارتفاع ضغط الدم المزمن.",
    serviceMaged2Title: "تشخيص أمراض الكلى",
    serviceMaged2Desc: "تشخيص وعلاج حالات القصور الكلوي الحاد والمزمن ومتابعة الغسيل.",
    serviceMaged3Title: "أمراض الجهاز الهضمي",
    serviceMaged3Desc: "متابعة أمراض الجهاز الهضمي والقولون.",
    serviceMaged4Title: "الفحص الدوري الشامل",
    serviceMaged4Desc: "الفحص الدوري الشامل للبالغين.",
    servicesShahiraTitle: "خدمات الأطفال وحديثي الولادة (د/ شهيرة لويز)",
    serviceShahira1Title: "رعاية حديثي الولادة",
    serviceShahira1Desc: "متابعة شاملة لنمو الطفل منذ اليوم الأول ودعم الرضاعة الطبيعية.",
    serviceShahira2Title: "التطعيمات وجداول النمو",
    serviceShahira2Desc: "توفير جميع التطيمات الأساسية والإضافية ومتابعة النمو.",
    serviceShahira3Title: "علاج أمراض الأطفال",
    serviceShahira3Desc: "تشخيص وعلاج أمراض الجهاز التنفسي والنزلات المعوية الشائعة.",
    serviceShahira4Title: "التوجيه الغذائي للطفل",
    serviceShahira4Desc: "علاج حالات سوء التغذية، النحافة، والسمنة عند الأطفال.",
    serviceShahira5Title: "حساسية الصدر والربو",
    serviceShahira5Desc: "تشخيص وعلاج حالات حساسية الصدر والربو عند الأطفال.",
    serviceShahira6Title: "متابعة النمو والتطور",
    serviceShahira6Desc: "متابعة التطور الحركي والذهني للطفل والتأكد من سلامته.",
    doctorsTitle: "فريق الأطباء",
    doctorMagedSpecialty: "تخصص: [استشاري الباطنة والكلي والسكر]",
    doctorShahiraSpecialty: "تخصص: [استشاري الاطفال وحديثي الولاده]",
    doctorLearnMore: "اضغط لمعرفة المزيد...",
    testimonialsTitle: " اراء مرضانا",
    testimonial1Quote: '"رعاية ممتازة واهتمام حقيقي بصحة ابني. شكراً جزيلاً د/ شهيرة لويز على احترافيتك وذوقك."',
    testimonial1Author: "- السيد/  أحمد",
    testimonial2Quote: '"متابعة دقيقة لمرض السكري. د/ ماجد فوزي من أفضل وأشطر الأطباء الذين تعاملت معهم. أنصح به بشدة."',
    testimonial2Author: "- الأستاذ/  فؤاد",
    testimonial3Quote: '"العيادة نظيفة جداً ومنظمة، والممرضات متعاونات وودودات. تجربة مريحة والانتظار لم يكن طويلاً."',
    testimonial3Author: "- السيدة/ سارة",
    bookingTitle: "حجز موعد",
    bookingSubtitle: "اختر الطبيب لإتمام الحجز:",
    bookingBtnMaged: "حجز موعد\n(د/ ماجد فوزي)",
    bookingBtnShahira: "حجز موعد\n(د/ شهيرة لويز)",
    contactAddress: "العنوان: [16-عمارات صقر قريش -بجوار البحث الجنائي-المعادي الجديده]",
    contactPhone: "رقم الهاتف: [27474381-27475230-01275574553]",
    contactEmail: "البريد الإلكتروني: [clinicfamily222@gmail.com]",
    footerRights: "© 2025 عيادة [family clinic]. جميع الحقوق محفوظة.",
    drMagedPageTitle: "د/ ماجد فوزي - استشاري الباطنة والكلى والسكر",
    drMagedProfileTitle: "ملف الطبيب: د/ ماجد فوزي",
    drMagedSpecialty: "استشاري الباطنة والكلى والسكر",
    drMagedBio: "بدأت العمل بالعيادة منذ عام 2001 وأتشرف بمتابعة الأمراض المزمنة من: ارتفاع ضغط الدم، مرض السكر، ارتفاع نسب الدهون بالدم، أمراض الكلى، ومرض النقرس. وبالطبع، أمراض المعدة والقولون وقصور الغدة الدرقية.",
    drProfileServicesTitle: "التخصصات والخدمات المقدمة:",
    drMagedService1: "تشخيص ومتابعة مرضى السكري النوع الأول والثاني.",
    drMagedService2: "علاج ارتفاع ضغط الدم وأمراض الكلى المزمنة.",
    drMagedService3: "متابعة أمراض الجهاز الهضمي والقولون.",
    drMagedService4: "الفحص الدوري الشامل للبالغين.",
    drMagedBookBtn: "احجز موعد مع د/ ماجد",
    drShahiraPageTitle: "د/ شهيرة لويز - استشاري الاطفال وحديثي الولادة",
    drShahiraProfileTitle: "ملف الطبيبة: د/ شهيرة لويز",
    drShahiraSpecialty: "استشاري الاطفال وحديثي الولادة",
    drShahiraBio: "بدأت العمل بالعيادة سنة 1999 وحتى اليوم، ودائماً أستمتع بخدمة جميع الأطفال من عمر يوم وحتى اثني عشر عاماً. وأعتبر جميع أطفالنا هم عطايا الله، ويجب علينا تنمية هذه العطايا والحفاظ عليهم وتقديم أفضل رعاية لهم من صحة وتعليم وتغذية.",
    drShahiraService1: "فحص ومتابعة الأطفال حديثي الولادة .",
    drShahiraService2: "إدارة برامج التطعيمات والتحصينات الوقائية.",
    drShahiraService3: "علاج أمراض الطفولة الشائعة والموسمية.",
    drShahiraService4: "استشارات التغذية الصحية ونمو الطفل.",
    drShahiraBookBtn: "احجز موعد مع د/ شهيرة",
    bookMagedPageTitle: "حجز موعد مع د/ ماجد فوزي",
    bookShahiraPageTitle: "حجز موعد مع د/ شهيرة لويز",
    bookMoreInfo: "المزيد من المعلومات:",
    drMagedInfo1: "• خبرة 20+ سنة في المجال.",
    drMagedInfo2: "• يركز على الرعاية الشاملة للمرضى.",
    drShahiraInfo1: "• متخصصة في رعاية الطفولة المبكرة.",
    drShahiraInfo2: "• توفير بيئة مريحة للأطفال.",
    bookConfirmTitle: "تأكيد حجز موعد",
    bookConfirmSubtitle: "أكمل النموذج لتأكيد حجزك مع الطبيب المختص.",
    formFullName: "الاسم الكامل",
    formErrorName: "يجب إدخال اسم صحيح (أكثر من حرفين)",
    formEmail: "البريد الإلكتروني",
    formErrorEmail: "الرجاء إدخال بريد إلكتروني صحيح",
    formPhone: "رقم الهاتف",
    formErrorPhone: "الرجاء إدخال رقم هاتف صحيح (10 أو 11 رقم)",
    formDrMagedSelected: "د. [د/ ماجد فوزي] (محدد)",
    formDrShahiraSelected: "د. [د/ شهيرة لويز] (محدد)",
    formPaymentMethod: "اختر طريقة الدفع:",
    formPaymentSelect: "اختر الطريقة...",
    formPaymentCash: "نقداً في العيادة",
    formPaymentInstapay: "InstaPay / تحويل بنكي",
    formInstapayTitle: "تفاصيل دفع InstaPay",
    formInstapayDesc: "يرجى التحويل إلى عنوان الدفع التالي:",
    formInstapayIPA: "IPA:",
    formInstapayPhone: "أو رقم هاتف:",
    formInstapayWarning: "⚠️ يرجى إرفاق صورة التحويل أدناه لتأكيد الحجز. (أو إرسالها عبر الواتساب).",
    formInstapayRef: "أدخل رقم مرجع التحويل (اختياري)",
    formInstapayUpload: "إرفاق صورة التحويل:",
    formDateTime: "اختر التاريخ أولاً:", 
    formDateTimePlaceholder: "اختر اليوم المناسب...",
    formSubmitBtn: "تأكيد حجز الموعد",
    
    // --- (معدل) تعديل ترجمات الأسعار (بدون strong) ---
    formPriceMagedNew: "سعر الكشف: 1000 جنيه مصري",
    formPriceMagedFollowup: "سعر الاستشارة: 500 جنيه مصري",
    formPriceMagedNote: "⚠️ ملاحظة: الاستشارة صالحة خلال 15 يوم فقط من تاريخ الكشف.",
    formPriceShahiraNew: "سعر الكشف: 550 جنيه مصري",
    formPriceShahiraFollowup: "سعر الاستشارة: 250 جنيه مصري",
    formPriceShahiraNote: "⚠️ ملاحظة: الاستشارة صالحة خلال 7 أيام فقط من تاريخ الكشف.",
    
    // --- (معدل) تعديل نوع الزيارة (للقائمة المنسدلة) ---
    formAppointmentType: "اختر نوع الزيارة:",
    formAppointmentTypeSelect: "اختر نوع الزيارة...", // (جديد)
    formAppointmentTypeNew: "كشف جديد",
    formAppointmentTypeFollowup: "استشارة / متابعة",
    // --- (نهاية التعديلات) ---

    slotsAfternoon: "الفترة الصباحية",
    slotsEvening: "الفترة المسائية",
    slotsInsuranceAfternoon: "الفترة الصباحية",
    slotsInsuranceEvening: "الفترة المسائية",

    formInsuranceCompany: "شركة التأمين (اختياري):",
    formInsuranceNone: "لا يوجد تأمين / دفع نقدي",
    formInsuranceCardUpload: "إرفاق صورة كارنيه التأمين:",
    formInsuranceCardRequired: "⚠️ مطلوب لتأكيد الحجز بالتأمين.",
    partnersTitle: "شركات التأمين  ",
    partnerUnicare: "Unicare",
    partnerCareplus: "Care Plus",
    partnerMedright: "MedRight",
    partnerNextcare: "NEXT CARE",
    partnerAlAhly: "الأهلي للخدمات الطبية",
    partnerLawyers: "نقابة المحامين",
    partnerEgycare: "EGYCARE",
    partnerDMS: "DMS",
    partnerEngineers: "نقابة المهندسين",
    partnerAXA: "AXA",
    partnermedical:"نقابة الاطباء",
  },
  en: {
    siteTitle: "[Family Clinic]",
    logoText: "Family Clinic", 
    navHome: "Home",
    navAbout: "About Us", 
    navServices: "Services",
    navDoctors: "Doctors",
    navBooking: "Book Appointment",
    navContact: "Contact Us",
    navDrMaged: "Dr. Maged fawzy", 
    navDrShahira: "Dr. Shahira louis",
    langBtn: "العربية", 
    heroTitle: "We Care About Your Health",
    heroSubtitle: "The best medical care by the most skilled doctors.",
    heroBtn: "Book an Appointment Now",
    aboutTitle: "About Us",
    aboutText: "[Family Clinic] is an integrated medical center that combines deep expertise with individual attention to provide the best healthcare for all family members. We believe health is the foundation of a happy life, committing to accurate diagnostic and therapeutic services in a comfortable, safe environment.",
    missionTitle: "Our Mission",
    missionText: "To provide high-quality, professional, and accurate healthcare services, focusing on building a lasting relationship of trust with our patients through health education and continuous support.",
    visionTitle: "Our Vision",
    visionText: "To be the leading and trusted clinic in providing comprehensive and innovative healthcare, and to become the first choice for families seeking medical excellence and human compassion.",
    servicesTitle: "Our Services",
    servicesMagedTitle: "Internal Medicine & Kidney Services (Dr. Maged fawzy)",
    serviceMaged1Title: "Diabetes & Pressure Follow-up",
    serviceMaged1Desc: "Regular follow-up for chronic diabetes and hypertension cases.",
    serviceMaged2Title: "Kidney Disease Diagnosis",
    serviceMaged2Desc: "Diagnosis and treatment of acute and chronic renal failure and dialysis follow-up.",
    serviceMaged3Title: "Gastrointestinal Diseases",
    serviceMaged3Desc: "Follow-up for gastrointestinal and colon diseases.",
    serviceMaged4Title: "Periodic Check-ups",
    serviceMaged4Desc: "Comprehensive periodic check-ups for adults.",
    servicesShahiraTitle: "Pediatrics & Neonatal Services (Dr. Shahira louis)",
    serviceShahira1Title: "Newborn Care",
    serviceShahira1Desc: "Comprehensive follow-up of child growth from day one and breastfeeding support.",
    serviceShahira2Title: "Vaccinations & Growth Charts",
    serviceShahira2Desc: "Providing all basic and additional vaccinations and monitoring growth.",
    serviceShahira3Title: "Pediatric DiseaseTreatment",
    serviceShahira3Desc: "Diagnosis and treatment of common respiratory diseases and gastroenteritis.",
    serviceShahira4Title: "Child Nutritional Guidance",
    serviceShahira4Desc: "Treating malnutrition, underweight, and obesity cases in children.",
    serviceShahira5Title: "Chest Allergy & Asthma",
    serviceShahira5Desc: "Diagnosis and treatment of chest allergy and asthma in children.",
    serviceShahira6Title: "Growth & Development Follow-up",
    serviceShahira6Desc: "Monitoring the child's motor and mental development and ensuring their well-being.",
    doctorsTitle: "Our Doctors",
    doctorMagedSpecialty: "Specialty: [Consultant of Internal Medicine, Kidney & Diabetes]",
    doctorShahiraSpecialty: "Specialty: [Consultant of Pediatrics & Neonatology]",
    doctorLearnMore: "Click to learn more...",
    testimonialsTitle: "What They Say About Us",
    testimonial1Quote: '"Excellent care and genuine concern for my son\'s health. Thank you Dr. Shahira louis for your professionalism and kindness."',
    testimonial1Author: "- Mrs. Ahmed",
    testimonial2Quote: '"Accurate follow-up for my diabetes. Dr. Maged fawzy is one of the best and most skilled doctors I have dealt with. Highly recommended."',
    testimonial2Author: "- Mr.  Fouad",
    testimonial3Quote: '"The clinic is very clean and organized, and the nurses are cooperative and friendly. A comfortable experience and the wait was not long."',
    testimonial3Author: "- Ms. Sara",
    bookingTitle: "Book Appointment",
    bookingSubtitle: "Choose the doctor to complete the booking:",
    bookingBtnMaged: "Book Appointment\n(Dr. Maged fawzy)",
    bookingBtnShahira: "Book Appointment\n(Dr. Shahira louis)",
    contactAddress: "Address: [16 Saqr Quraish Buildings - Next to Criminal Investigation - New Maadi]",
    contactPhone: "Phone: [27474381 - 27475230 - 01275574553]",
    contactEmail: "Email: [clinicfamily222@gmail.com]",
    footerRights: "© 2025 [Family Clinic]. All rights reserved.",
    drMagedPageTitle: "Dr. Maged fawzy - Consultant of Internal Medicine, Kidney & Diabetes",
    drMagedProfileTitle: "Doctor's Profile: Dr. Maged fawzy",
    drMagedSpecialty: "Consultant of Internal Medicine, Kidney & Diabetes",
    drMagedBio: "I started working at the clinic in 2001, and I am honored to manage chronic diseases including: hypertension, diabetes, high blood lipids, kidney diseases, and gout. And of course, I also manage stomach, colon, and thyroid gland disorders.",
    drProfileServicesTitle: "Specialties and Services Offered:",
    drMagedService1: "Diagnosis and follow-up for type 1 and type 2 diabetes patients.",
    drMagedService2: "Treatment of hypertension and chronic kidney diseases.",
    drMagedService3: "Follow-up for gastrointestinal and colon diseases.",
    drMagedService4: "Comprehensive periodic check-ups for adults.",
    drMagedBookBtn: "Book Appointment with Dr. Maged fawzy",
    drShahiraPageTitle: "Dr. Shahira louis - Consultant of Pediatrics & Neonatology",
    drShahiraProfileTitle: "Doctor's Profile: Dr. Shahira louis",
    drShahiraSpecialty: "Consultant of Pediatrics & Neonatology",
    drShahiraBio: "I started working at the clinic in 1999 and continue to this day, and I always enjoy serving all children from one day old up to twelve years old. I consider all our children to be gifts from God, and we must nurture these gifts, protect them, and provide them with the best care in terms of health, education, and nutrition.",
    drShahiraService1: "Examination and follow-up of newborns and premature infants.",
    drShahiraService2: "Management of vaccination programs and preventive immunizations.",
    drShahiraService3: "Treatment of common and seasonal childhood illnesses.",
    drShahiraService4: "Consultations on healthy nutrition and child development.",
    drShahiraBookBtn: "Book Appointment with Dr. Shahira louis",
    bookMagedPageTitle: "Book Appointment with Dr. Maged fawzy",
    bookShahiraPageTitle: "Book Appointment with Dr. Shahira louis",
    bookMoreInfo: "More Information:",
    drMagedInfo1: "• 20+ years of experience in the field.",
    drMagedInfo2: "• Focuses on comprehensive patient care.",
    drShahiraInfo1: "• Specializes in early childhood care.",
    drShahiraInfo2: "• Provides a comfortable environment for children.",
    bookConfirmTitle: "Confirm Your Appointment",
    bookConfirmSubtitle: "Complete the form to confirm your booking with the specialist.",
    formFullName: "Full Name",
    formErrorName: "Must enter a valid name (more than 2 characters)",
    formEmail: "Email Address",
    formErrorEmail: "Please enter a valid email address",
    formPhone: "Phone Number",
    formErrorPhone: "Please enter a valid phone number (10 or 11 digits)",
    formDrMagedSelected: "Dr. [Dr. Maged fawzy] (Selected)",
    formDrShahiraSelected: "Dr. [Dr. Shahira louis] (Selected)",
    formPaymentMethod: "Choose Payment Method:",
    formPaymentSelect: "Select method...",
    formPaymentCash: "Cash at the clinic",
    formPaymentInstapay: "InstaPay / Bank Transfer",
    formInstapayTitle: "InstaPay Payment Details",
    formInstapayDesc: "Please transfer to the following payment address:",
    formInstapayIPA: "IPA:",
    formInstapayPhone: "Or Phone Number:",
    formInstapayWarning: "⚠️ Please attach the transfer screenshot below to confirm the booking. (Or send via WhatsApp).",
    formInstapayRef: "Enter Transaction Reference ID (Optional)",
    formInstapayUpload: "Attach Transfer Screenshot:",
    formDateTime: "Select Date First:",
    formDateTimePlaceholder: "Select a suitable day...",
    formSubmitBtn: "Confirm Appointment",

    // --- (معدل) تعديل ترجمات الأسعار (بدون strong) ---
    formPriceMagedNew: "Appointment Fee: 1000 EGP",
    formPriceMagedFollowup: "Follow-up Fee: 500 EGP",
    formPriceMagedNote: "⚠️ Note: Follow-up is valid within 15 days of the appointment date.",
    formPriceShahiraNew: "Appointment Fee: 550 EGP",
    formPriceShahiraFollowup: "Follow-up Fee: 250 EGP",
    formPriceShahiraNote: "⚠️ Note: Follow-up is valid within 7 days of the appointment date.",
    
    // --- (معدل) تعديل نوع الزيارة (للقائمة المنسدلة) ---
    formAppointmentType: "Select Visit Type:",
    formAppointmentTypeSelect: "Select visit type...", // (جديد)
    formAppointmentTypeNew: "New Appointment",
    formAppointmentTypeFollowup: "Follow-up",
    // --- (نهاية التعديلات) ---
    
    slotsAfternoon: "Morning Slots",
    slotsEvening: "Evening Slots",
    slotsInsuranceAfternoon: "Morning Slots",
    slotsInsuranceEvening: "Evening Slots",

    formInsuranceCompany: "Insurance Company (Optional):",
    formInsuranceNone: "No Insurance / Self-Pay",
    formInsuranceCardUpload: "Attach Insurance Card Photo:",
    formInsuranceCardRequired: "⚠️ Required to confirm booking with insurance.",
    partnersTitle: "Our Insurance Partners",
    partnerUnicare: "Unicare",
    partnerCareplus: "Care Plus",
    partnerMedright: "MedRight",
    partnerNextcare: "NEXT CARE",
    partnerAlAhly: "Al Ahly Medical Company",
    partnerLawyers: "Lawyers Syndicate",
    partnerEgycare: "EGYCARE",
    partnerDMS: "DMS",
    partnerEngineers: "Engineers Syndicate",
    partnerAXA: "AXA",
    partnermedical:"Medical Syndicate",
  }
};
// --- نهاية قاموس الترجمة ---

let allBookedSlotsCache = {}; 

async function fetchBookedTimes(doctorId) {
  try {
    const response = await fetch(`get_booked_times.php?doctor=${doctorId}&_=${new Date().getTime()}`);
    allBookedSlotsCache = await response.json(); 
  } catch (e) {
    console.error("فشل في جلب المواعيد المحجوزة:", e);
    allBookedSlotsCache = {}; 
  }
}

/**
 * (معدلة بالكامل) دالة لإنشاء وإظهار مربعات الوقت
 */
function populateTimeSlots(selectedDate, timeSlotsContainer, hiddenDateTimeField, lang) {
  
  const oldSelectedTime = hiddenDateTimeField.value.startsWith(selectedDate) 
                          ? hiddenDateTimeField.value.split(' ')[1] 
                          : '';
  timeSlotsContainer.innerHTML = ''; 
  document.getElementById('time-error-message')?.classList.remove('show');
  
  const insuranceSelect = document.getElementById("insurance-company-select");
  const isInsuranceBooking = insuranceSelect && insuranceSelect.value !== "";
  
  const isDoctor1 = document.getElementById('booking-datetime-magid') !== null;
  
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth() + 1).padStart(2, '0');
  const d = String(now.getDate()).padStart(2, '0');
  const todayStr = `${y}-${m}-${d}`;
  const isToday = (selectedDate === todayStr);
  const currentHour = String(now.getHours()).padStart(2, '0');
  const currentMinute = String(now.getMinutes()).padStart(2, '0');
  const currentTimeStr = `${currentHour}:${currentMinute}`; 
  
  // *** مواعيد العادي (لكل الدكاترة) ***
  const regularAfternoonSlots = ["13:30", "14:00", "14:30", "15:00", "15:30", "16:00", "16:30", "17:00"];
  const regularEveningSlots = ["20:30", "21:00", "21:30", "22:00", "22:30", "23:00", "23:30"];
  
  let insuranceAfternoonSlots, insuranceEveningSlots;
  
  if (isDoctor1) {
      // (د. ماجد) - 4 مواعيد فقط
      insuranceAfternoonSlots = ["14:00", "14:30", "15:00", "15:30"]; 
      insuranceEveningSlots = ["21:00", "21:30", "22:00", "22:30"];
  } else {
      // (د. شهيرة) - 4 مواعيد فقط (زي ما طلبت)
      insuranceAfternoonSlots = ["13:30", "14:00", "14:30", "15:00"]; 
      insuranceEveningSlots = ["20:30", "21:00", "21:30", "22:00"];
  }

  let afternoonSlots, eveningSlots, afternoonTitleKey, eveningTitleKey;
  
  if (isInsuranceBooking) {
    afternoonSlots = insuranceAfternoonSlots;
    eveningSlots = insuranceEveningSlots;
    afternoonTitleKey = 'slotsInsuranceAfternoon';
    eveningTitleKey = 'slotsInsuranceEvening';
  } else {
    afternoonSlots = regularAfternoonSlots;
    eveningSlots = regularEveningSlots;
    afternoonTitleKey = 'slotsAfternoon';
    eveningTitleKey = 'slotsEvening';
  }

  let html = '';
  const afternoonTitle = translations[lang][afternoonTitleKey];
  const eveningTitle = translations[lang][eveningTitleKey];

  // 4. بناء مربعات الفترة الصباحية
  let afternoonSlotsAvailable = 0; 
  let afternoonHtml = '';
  
  afternoonSlots.forEach(time => {
    const fullDateTimeString = `${selectedDate} ${time}`;
    const counts = allBookedSlotsCache[fullDateTimeString] || { regular: 0, insurance: 0 };
    
    let bookedCount, maxCapacity, titleHint;
    
    if (isInsuranceBooking) {
        bookedCount = counts.insurance;
        maxCapacity = isDoctor1 ? 1 : 2; // د.ماجد: 1، د.شهيرة: 2
        titleHint = `(تأمين متاح ${maxCapacity - bookedCount} من ${maxCapacity})`;
    } else {
        bookedCount = counts.regular;
        maxCapacity = 1; // العادي دايماً 1
        titleHint = `(عادي متاح ${maxCapacity - bookedCount} من ${maxCapacity})`;
    }

    const isPast = (isToday && time < currentTimeStr); 
    const isDisabled = (bookedCount >= maxCapacity) || isPast; 

    if (isDisabled && !isPast) titleHint = "(مكتمل)";
    if (isPast) titleHint = "(ميعاد فات)";

    const isSelected = (!isDisabled && time === oldSelectedTime); 
    
    if (!isDisabled) { 
      afternoonSlotsAvailable++;
    }

    afternoonHtml += `<button 
                        type="button" 
                        class="time-slot-box ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}" 
                        data-time="${time}" 
                        ${isDisabled ? 'disabled' : ''}
                        title="${titleHint}" 
                      >${time}</button>`;
  });
  
  if (afternoonSlots.length > 0) { 
     html += `<h4>${afternoonTitle}</h4><div class="slots-grid">`;
     html += afternoonHtml; 
     html += '</div>';
  }

  // 5. بناء مربعات الفترة المسائية
  let eveningSlotsAvailable = 0; 
  let eveningHtml = '';
  
  eveningSlots.forEach(time => {
    const fullDateTimeString = `${selectedDate} ${time}`;
    const counts = allBookedSlotsCache[fullDateTimeString] || { regular: 0, insurance: 0 };
    
    let bookedCount, maxCapacity, titleHint;

    if (isInsuranceBooking) {
        bookedCount = counts.insurance;
        maxCapacity = isDoctor1 ? 1 : 2; // د.ماجد: 1، د.شهيرة: 2
        titleHint = `(تأمين متاح ${maxCapacity - bookedCount} من ${maxCapacity})`;
    } else {
        bookedCount = counts.regular;
        maxCapacity = 1;
        titleHint = `(عادي متاح ${maxCapacity - bookedCount} من ${maxCapacity})`;
    }
    
    const isPast = (isToday && time < currentTimeStr);
    const isDisabled = (bookedCount >= maxCapacity) || isPast;
    const isSelected = (!isDisabled && time === oldSelectedTime);
    
    if (!isDisabled) { 
      eveningSlotsAvailable++;
    }
    
    if (isDisabled && !isPast) titleHint = "(مكتمل)";
    if (isPast) titleHint = "(ميعاد فات)";

    eveningHtml += `<button 
                      type="button" 
                      class="time-slot-box ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}" 
                      data-time="${time}" 
                      ${isDisabled ? 'disabled' : ''}
                      title="${titleHint}"
                    >${time}</button>`;
  });

  if (eveningSlots.length > 0) { 
     html += `<h4>${eveningTitle}</h4><div class="slots-grid">`;
     html += eveningHtml; 
     html += '</div>';
  }

  timeSlotsContainer.innerHTML = html;
  timeSlotsContainer.style.display = 'block';

  timeSlotsContainer.querySelectorAll('.time-slot-box:not(.disabled)').forEach(box => {
    box.addEventListener('click', () => {
      timeSlotsContainer.querySelectorAll('.time-slot-box').forEach(b => b.classList.remove('selected'));
      box.classList.add('selected');
      const selectedTime = box.dataset.time;
      hiddenDateTimeField.value = `${selectedDate} ${selectedTime}`;
      document.getElementById('time-error-message')?.classList.remove('show');
    });
  });
}


/**
 * (معدل) دالة لتهيئة التقويم (Flatpickr)
 */
async function initFlatpickr(lang) {
  
  const locale = lang === 'ar' ? 'ar' : 'default';
  let doctorId = '';
  let isDoctor1 = false; 
  
  const datePickerMagid = document.getElementById('booking-date-picker-magid');
  const datePickerShahira = document.getElementById('booking-date-picker-shahira');
  const timeSlotsContainer = document.getElementById('time-slots-container');
  
  let datePickerElement = null;
  let hiddenDateTimeField = null;

  if (datePickerMagid) {
    doctorId = 'doctor1';
    isDoctor1 = true; 
    datePickerElement = datePickerMagid;
    hiddenDateTimeField = document.getElementById('booking-datetime-magid');
  } else if (datePickerShahira) {
    doctorId = 'doctor2';
    datePickerElement = datePickerShahira;
    hiddenDateTimeField = document.getElementById('booking-datetime-shahira');
  }
  
  if (!datePickerElement || !timeSlotsContainer || !hiddenDateTimeField) {
    return;
  }
  
  await fetchBookedTimes(doctorId); 
  
  const flatpickrConfig = {
    locale: locale,
    enableTime: false, 
    dateFormat: 'Y-m-d', 
    minDate: 'today',
    disable: [], // سيتم ملؤها
    onChange: function(selectedDates, dateStr, instance) {
      if (selectedDates.length === 0) {
        timeSlotsContainer.style.display = 'none';
        hiddenDateTimeField.value = '';
        return;
      }
      const selectedDate = dateStr;
      populateTimeSlots(selectedDate, timeSlotsContainer, hiddenDateTimeField, lang);
    },
    onClose: function(selectedDates, dateStr, instance) {
       if (selectedDates.length === 0) {
          if (datePickerElement.value === '') {
            timeSlotsContainer.style.display = 'none';
            hiddenDateTimeField.value = '';
          }
       }
    }
  };

  // --- تطبيق قواعد قفل الأيام ---
  const disableRules = [
      function(date) { return (date.getDay() === 5); } // 1. قفل يوم الجمعة
  ];

  const insuranceSelect = document.getElementById("insurance-company-select");
  const isInsuranceBooking = insuranceSelect && insuranceSelect.value !== "";

  // 2. تطبيق قاعدة الـ 20 يوم (فقط لدكتور ماجد + تأمين)
  if (isDoctor1 && isInsuranceBooking) {
      const today = new Date();
      const in20Days = new Date();
      in20Days.setDate(today.getDate() + 20);
      
      const formatDate = (d) => {
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, '0');
          const day = String(d.getDate()).padStart(2, '0');
          return `${y}-${m}-${day}`;
      };

      disableRules.push({
          from: formatDate(today),
          to: formatDate(in20Days)
      });
  }
  
  flatpickrConfig.disable = disableRules;
  // --- نهاية قواعد قفل الأيام ---

  const oldInstance = datePickerElement._flatpickr;
  if (oldInstance) {
    const currentValue = oldInstance.input.value;
    oldInstance.destroy();
    if (currentValue) {
        datePickerElement.value = currentValue;
    }
  }
  
  flatpickr(datePickerElement, flatpickrConfig);
}

/**
 * الدالة الرئيسية لضبط اللغة
 */
function setLanguage(lang) {
  if (lang !== 'ar' && lang !== 'en') { lang = 'ar'; }
  localStorage.setItem('clinicLang', lang); 
  document.documentElement.lang = lang;
  document.documentElement.dir = (lang === 'ar' ? 'rtl' : 'ltr');
  document.body.className = (lang === 'ar' ? 'lang-ar' : 'lang-en');
  const langData = translations[lang];

  document.querySelectorAll('[data-lang-key]').forEach(element => {
    const key = element.getAttribute('data-lang-key');
    const translation = langData[key];
    if (translation) {
      if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
        if (element.placeholder) { element.placeholder = translation; }
      } 
      // (جديد) تعديل للـ <option> الافتراضي في القوائم المنسدلة
      else if (element.tagName === 'OPTION' && element.value === '') {
        element.textContent = translation;
      }
      else if (key === 'bookingBtnMaged' || key === 'bookingBtnShahira') {
        element.innerHTML = translation.replace('\n', '<br />');
      }
      else { element.textContent = translation; }
    }
  });

  // --- (جديد) تحديث صندوق السعر الديناميكي إذا كان ظاهراً ---
  const priceDetailsDisplay = document.getElementById('price-details-display');
  const visitTypeSelect = document.getElementById('appointment-type-select');
  if (priceDetailsDisplay && visitTypeSelect && visitTypeSelect.value) {
    const selectedValue = visitTypeSelect.value;
    const isDoctor1 = document.getElementById('booking-datetime-magid') !== null;
    let priceHtml = '';
    
    if (selectedValue === 'new') {
      const priceKey = isDoctor1 ? 'formPriceMagedNew' : 'formPriceShahiraNew';
      priceHtml = `<p>${langData[priceKey]}</p>`;
    } else if (selectedValue === 'followup') {
      const priceKey = isDoctor1 ? 'formPriceMagedFollowup' : 'formPriceShahiraFollowup';
      const noteKey = isDoctor1 ? 'formPriceMagedNote' : 'formPriceShahiraNote';
      priceHtml = `<p>${langData[priceKey]}</p><p class="important-note">${langData[noteKey]}</p>`;
    }
    priceDetailsDisplay.innerHTML = priceHtml;
  }
  // --- (نهاية الإضافة) ---

  if (typeof flatpickr === 'function') { initFlatpickr(lang); }

  const timeSlotsContainer = document.getElementById('time-slots-container');
  if (timeSlotsContainer && timeSlotsContainer.style.display === 'block') {
    let datePickerElement = null;
    let hiddenDateTimeField = null;
    if (document.getElementById('booking-date-picker-magid')) {
      datePickerElement = document.getElementById('booking-date-picker-magid');
      hiddenDateTimeField = document.getElementById('booking-datetime-magid');
    } else if (document.getElementById('booking-date-picker-shahira')) {
      datePickerElement = document.getElementById('booking-date-picker-shahira');
      hiddenDateTimeField = document.getElementById('booking-datetime-shahira');
    }
    if (datePickerElement && datePickerElement.value && hiddenDateTimeField) {
      const selectedDate = datePickerElement.value; 
      populateTimeSlots(selectedDate, timeSlotsContainer, hiddenDateTimeField, lang);
    }
  }
}

function initLanguageSwitcher() {
  const langToggleBtn = document.getElementById('lang-toggle-btn');
  if (langToggleBtn) {
    langToggleBtn.addEventListener('click', () => {
      const currentLang = localStorage.getItem('clinicLang') || 'ar';
      const newLang = currentLang === 'ar' ? 'en' : 'ar';
      setLanguage(newLang);
    });
  }
}

AOS.init({ duration: 800, once: true, easing: 'ease-in-out', offset: 100 });

document.addEventListener('DOMContentLoaded', () => {
  const splashScreen = document.getElementById('splash-screen');
  const mainContent = document.getElementById('main-content');
  
  // ==============================================
  // ========= ( ( (  هنا التعديل  ) ) ) =========
  // ==============================================
  function showMainContent() {
    if (splashScreen && mainContent) {
      splashScreen.classList.add('hidden'); 
      setTimeout(() => {
        splashScreen.style.display = 'none'; 
        mainContent.style.display = 'block'; 
        AOS.refresh();
        
        // --- هذا هو الكود الجديد ---
        // بعد إظهار المحتوى، تحقق من وجود هاش (مثل #services)
        const hash = window.location.hash;
        if (hash) {
          // حاول العثور على العنصر
          const targetElement = document.querySelector(hash);
          if (targetElement) {
            // قم بالتمرير إليه
            targetElement.scrollIntoView({ behavior: 'smooth' });
          }
        }
        // --- نهاية الكود الجديد ---

      }, 1000); 
    } else if (mainContent) {
      mainContent.style.display = 'block';
      AOS.refresh();
      
      // --- (احتياطي) إضافة نفس المنطق هنا أيضاً ---
      const hash = window.location.hash;
      if (hash) {
        const targetElement = document.querySelector(hash);
        if (targetElement) {
          targetElement.scrollIntoView({ behavior: 'smooth' });
        }
      }
      // --- نهاية الإضافة ---
    }
  }
  // ==============================================
  // ========= ( ( ( نهاية التعديل ) ) ) =========
  // ==============================================

  setTimeout(showMainContent, 1000); 

  initLanguageSwitcher();
  const savedLang = localStorage.getItem('clinicLang') || 'ar';
  setLanguage(savedLang);

  const navLinks = document.querySelectorAll('header nav a');
  const currentPage = window.location.href;
  navLinks.forEach((link) => {
    link.classList.remove('active');
    if (currentPage.includes(link.href)) {
      link.classList.add('active');
      const parentDropdown = link.closest('.dropdown');
      if (parentDropdown) {
        const dropbtn = parentDropdown.querySelector('.dropbtn');
        if (dropbtn) { dropbtn.classList.add('active'); }
      }
    }
  });
  const isHomePage = window.location.pathname === '/' || window.location.pathname.endsWith('index.html');
  if (isHomePage) {
    const hash = window.location.hash;
    navLinks.forEach((link) => link.classList.remove('active'));
    if (hash === '#about') { document.querySelector('header nav a[href*="#about"]').classList.add('active'); } 
    else if (hash === '#services') { document.querySelector('header nav a[href*="#services"]').classList.add('active'); } 
    else if (hash === '#doctors') { document.querySelector('header nav a[href*="#doctors"]').classList.add('active'); } 
    else if (hash === '#appointment') { document.querySelector('header nav a[href*="#appointment"]').classList.add('active'); } 
    else if (hash === '#contact') { document.querySelector('header nav a[href*="#contact"]').classList.add('active'); } 
    else { document.querySelector('header nav a[href*="#home"]').classList.add('active'); }
  }

  const header = document.querySelector('header');
  if (header) {
    window.addEventListener('scroll', () => {
      if (window.scrollY > 50) { header.classList.add('scrolled'); } 
      else { header.classList.remove('scrolled'); }
    });
  }
  
  // --- (معدل بالكامل) كود خاص بصفحات الحجز (الدفع والتحقق) ---
  
  const paymentSelect = document.getElementById("payment-method-select");
  const instapayBlock = document.getElementById("instapay-details-block");
  const instapayInput = document.getElementById("transaction-screenshot");
  
  const insuranceSelect = document.getElementById("insurance-company-select");
  const insuranceCardUploadBlock = document.getElementById("insurance-card-upload-block");
  const insuranceCardInput = document.getElementById("insurance-card-input");
  const paymentGroup = document.querySelector(".payment-method-group"); 

  // --- (جديد) جلب عناصر "نوع الزيارة" وصندوق السعر ---
  const visitTypeGroup = document.querySelector(".appointment-type-group");
  const visitTypeSelect = document.getElementById("appointment-type-select");
  const priceDetailsDisplay = document.getElementById('price-details-display');
  // --- (نهاية الإضافة) ---

  // (جديد) دالة لإعادة تحميل المواعيد عند تغيير الاختيار
  function refreshSlotsIfDateSelected() {
    const datePicker = document.getElementById('booking-date-picker-magid') || document.getElementById('booking-date-picker-shahira');
    if (datePicker && datePicker.value) {
      const lang = document.documentElement.lang;
      const container = document.getElementById('time-slots-container');
      const hiddenField = document.getElementById('booking-datetime-magid') || document.getElementById('booking-datetime-shahira');
      hiddenField.value = ''; 
      populateTimeSlots(datePicker.value, container, hiddenField, lang);
    }
  }
  
  // === كود حقل التأمين (معدل بالكامل لإضافة منطق نوع الزيارة) ===
  function toggleFields() {
      if (!insuranceSelect) return; 
      const isInsurance = insuranceSelect.value !== ""; 

      if (isInsurance) { 
        // (تأمين)
        if(insuranceCardUploadBlock) insuranceCardUploadBlock.style.display = "block";
        if(insuranceCardInput) insuranceCardInput.required = true;
        if(paymentGroup) paymentGroup.style.display = "none";
        if(paymentSelect) {
          paymentSelect.required = false;
          paymentSelect.disabled = true; 
        }

        // --- (جديد) إخفاء "نوع الزيارة" وإجبارها على "كشف جديد" ---
        if(visitTypeGroup) visitTypeGroup.style.display = "none";
        if(visitTypeSelect) {
            visitTypeSelect.value = "new"; // اجباري "جديد"
            visitTypeSelect.required = true;
        }
        if(priceDetailsDisplay) { // (جديد) إخفاء صندوق السعر
            priceDetailsDisplay.style.display = 'none';
            priceDetailsDisplay.innerHTML = '';
        }
        // --- (نهاية الإضافة) ---

      } else {
        // (دفع نقدي)
        if(insuranceCardUploadBlock) insuranceCardUploadBlock.style.display = "none";
        if(insuranceCardInput) insuranceCardInput.required = false;
        if(paymentGroup) paymentGroup.style.display = "block";
        if(paymentSelect) {
          paymentSelect.required = true; 
          paymentSelect.disabled = false; 
        }

        // --- (جديد) إظهار "نوع الزيارة" ---
        if(visitTypeGroup) visitTypeGroup.style.display = "block";
        if(visitTypeSelect) {
            visitTypeSelect.value = ""; // إجباره يختار
            visitTypeSelect.required = true; 
        }
        if(priceDetailsDisplay) { // (جديد) إخفاء صندوق السعر (حتى يختار)
            priceDetailsDisplay.style.display = 'none';
            priceDetailsDisplay.innerHTML = '';
        }
        // --- (نهاية الإضافة) ---
      }

      const lang = document.documentElement.lang || 'ar';
      
      // (معدل) أعد تهيئة التقويم بالكامل في الحالتين لتطبيق القواعد صح
      initFlatpickr(lang); 
      
      // امسح المواعيد والتاريخ القديم
      const timeSlotsContainer = document.getElementById('time-slots-container');
      if (timeSlotsContainer) timeSlotsContainer.innerHTML = '';
      if (timeSlotsContainer) timeSlotsContainer.style.display = 'none';
      
      const hiddenDateTimeField = document.getElementById('booking-datetime-magid') || document.getElementById('booking-datetime-shahira');
      if (hiddenDateTimeField) hiddenDateTimeField.value = '';
      
      const datePicker = document.getElementById('booking-date-picker-magid') || document.getElementById('booking-date-picker-shahira');
      if (datePicker) datePicker.value = ''; // إجبار المستخدم يختار تاريخ جديد
  }

  if (insuranceSelect) {
    toggleFields(); 
    insuranceSelect.addEventListener("change", toggleFields); 
  }
  // === (نهاية كود التأمين) ===

  // --- (جديد) إضافة Event Listener لـ "نوع الزيارة" لإظهار السعر ---
  if (visitTypeSelect && priceDetailsDisplay) {
      const isDoctor1 = document.getElementById('booking-datetime-magid') !== null;
      
      visitTypeSelect.addEventListener('change', () => {
        const selectedValue = visitTypeSelect.value;
        const lang = document.documentElement.lang || 'ar';
        const translationsData = translations[lang];
        let priceHtml = '';

        if (selectedValue === 'new') {
          const priceKey = isDoctor1 ? 'formPriceMagedNew' : 'formPriceShahiraNew';
          priceHtml = `<p>${translationsData[priceKey]}</p>`;
          priceDetailsDisplay.style.display = 'block';
        } else if (selectedValue === 'followup') {
          const priceKey = isDoctor1 ? 'formPriceMagedFollowup' : 'formPriceShahiraFollowup';
          const noteKey = isDoctor1 ? 'formPriceMagedNote' : 'formPriceShahiraNote';
          priceHtml = `<p>${translationsData[priceKey]}</p><p class="important-note">${translationsData[noteKey]}</p>`;
          priceDetailsDisplay.style.display = 'block';
        } else {
          priceDetailsDisplay.style.display = 'none';
          priceHtml = '';
        }
        priceDetailsDisplay.innerHTML = priceHtml;
      });
  }
  // --- (نهاية الإضافة) ---


  // === كود حقل انستا باي (زي ما هو، سليم) ===
  if (paymentSelect && instapayBlock && instapayInput) {
      function toggleInstapay() {
        if (paymentSelect.value === "instapay") {
          instapayBlock.style.display = "block";
          instapayInput.required = true; 
        } else {
          instapayBlock.style.display = "none";
          instapayInput.required = false; 
        }
      }
      toggleInstapay(); 
      paymentSelect.addEventListener("change", toggleInstapay);
  }
  // === (نهاية كود انستا باي) ===

  const form = document.getElementById('appointment-form');
  if (form) { 
    const nameInput = form.querySelector('input[name="name"]');
    const emailInput = form.querySelector('input[name="email"]');
    const phoneInput = form.querySelector('input[name="phone"]');
    const dateTimeInput = form.querySelector('input[name="booking_datetime"]');

    const validateEmail = (email) => {
      const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      return re.test(String(email).toLowerCase());
    };
    const validatePhone = (phone) => {
      const re = /^\d{10,11}$/;
      return re.test(String(phone));
    };

    if (nameInput) {
      nameInput.addEventListener('input', () => {
        if (nameInput.value.trim().length > 2) { nameInput.classList.add('valid'); nameInput.classList.remove('invalid'); } 
        else { nameInput.classList.add('invalid'); nameInput.classList.remove('valid'); }
      });
    }
    if (emailInput) {
      emailInput.addEventListener('input', () => {
        if (validateEmail(emailInput.value)) { emailInput.classList.add('valid'); emailInput.classList.remove('invalid'); } 
        else { emailInput.classList.add('invalid'); emailInput.classList.remove('valid'); }
      });
    }
    if (phoneInput) {
      phoneInput.addEventListener('input', () => {
        if (validatePhone(phoneInput.value)) { phoneInput.classList.add('valid'); phoneInput.classList.remove('invalid'); } 
        else { phoneInput.classList.add('invalid'); phoneInput.classList.remove('valid'); }
      });
    }
    
    form.addEventListener('submit', function(event) {
        let isValid = true;
        
        if (!dateTimeInput.value) {
            isValid = false;
            document.getElementById('time-error-message')?.classList.add('show');
            document.getElementById('time-error-message')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            document.getElementById('time-error-message')?.classList.remove('show');
        }
        
        if (!form.checkValidity()) {
            isValid = false;
        }
        
        if (!isValid) {
            event.preventDefault(); 
        }
    });
  } 

  const menuToggle = document.querySelector('.menu-toggle');
  const nav = document.querySelector('header nav');
  if (menuToggle && nav) {
    menuToggle.addEventListener('click', () => {
      nav.classList.toggle('is-active');
      const icon = menuToggle.querySelector('i');
      if (nav.classList.contains('is-active')) {
        icon.classList.remove('fa-bars');
        icon.classList.add('fa-xmark');
      } else {
        icon.classList.remove('fa-xmark');
        icon.classList.add('fa-bars');
      }
    });
  }
});